# BuzzIn GraphQL Schema

type User @model @auth(rules: [{allow: public}]) {
  id: ID!
  name: String!
  age: Int!
  bio: String
  photoRes: String!
  interests: [String]
  checkIns: [CheckIn] @hasMany(indexName: "byUser", fields: ["id"])
  swipesGiven: [Swipe] @hasMany(indexName: "byUser", fields: ["id"])
  swipesReceived: [Swipe] @hasMany(indexName: "byTargetUser", fields: ["id"])
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Location @model @auth(rules: [{allow: public}]) {
  id: ID!
  name: String!
  address: String!
  latitude: Float!
  longitude: Float!
  type: LocationType!
  checkIns: [CheckIn] @hasMany(indexName: "byLocation", fields: ["id"])
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

enum LocationType {
  COFFEE
  RESTAURANT
  BAR
  PARK
  GYM
  OTHER
}

type CheckIn @model @auth(rules: [{allow: public}]) {
  id: ID!
  userId: ID! @index(name: "byUser", sortKeyFields: ["checkInTime"])
  locationId: ID! @index(name: "byLocation", sortKeyFields: ["checkInTime"])
  user: User @belongsTo(fields: ["userId"])
  location: Location @belongsTo(fields: ["locationId"])
  checkInTime: AWSDateTime!
  checkOutTime: AWSDateTime
  isActive: Boolean!
  latitude: Float!
  longitude: Float!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Swipe @model @auth(rules: [{allow: public}]) {
  id: ID!
  userId: ID! @index(name: "byUser", sortKeyFields: ["timestamp"])
  targetUserId: ID! @index(name: "byTargetUser", sortKeyFields: ["timestamp"])
  user: User @belongsTo(fields: ["userId"])
  targetUser: User @belongsTo(fields: ["targetUserId"])
  locationId: ID!
  location: Location @belongsTo(fields: ["locationId"])
  action: SwipeAction!
  timestamp: AWSDateTime!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

enum SwipeAction {
  LIKE
  IGNORE
}

type Match @model @auth(rules: [{allow: public}]) @auth(rules: [{allow: public}]) {
  id: ID!
  user1Id: ID! @index(name: "byUser1", sortKeyFields: ["matchTime"])
  user2Id: ID! @index(name: "byUser2", sortKeyFields: ["matchTime"])
  user1: User @belongsTo(fields: ["user1Id"])
  user2: User @belongsTo(fields: ["user2Id"])
  locationId: ID!
  location: Location @belongsTo(fields: ["locationId"])
  matchTime: AWSDateTime!
  messageSent: Boolean!
  messages: [Message] @hasMany(indexName: "byMatch", fields: ["id"])
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Message @model @auth(rules: [{allow: public}]) {
  id: ID!
  matchId: ID! @index(name: "byMatch", sortKeyFields: ["timestamp"])
  match: Match @belongsTo(fields: ["matchId"])
  senderId: ID!
  sender: User @belongsTo(fields: ["senderId"])
  text: String!
  photoRes: String
  timestamp: AWSDateTime!
  isRead: Boolean!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

# Custom Queries
type Query {
  getActiveUsersAtLocation(locationId: ID!): [User]
    @function(name: "getActiveUsersAtLocation-${env}")

  listNearbyLocations(latitude: Float!, longitude: Float!, radiusKm: Float!): [Location]
    @function(name: "listNearbyLocations-${env}")
}

# Custom Mutations
type Mutation {
  performSwipe(userId: ID!, targetUserId: ID!, locationId: ID!, action: SwipeAction!): SwipeResult
    @function(name: "performSwipe-${env}")
}

type SwipeResult {
  swipe: Swipe!
  matched: Boolean!
  match: Match
}

# Subscriptions for real-time updates
type Subscription {
  onMatchCreatedForUser(userId: ID!): Match
    @aws_subscribe(mutations: ["performSwipe"])
}
